<?php
/*=================================================================
 * RecordRTC 音頻檔案刪除處理器
 * 
 * 作者: Muaz Khan - www.MuazKhan.com 
 * 授權: MIT License - https://www.webrtc-experiment.com/licence/
 * 文檔: https://github.com/muaz-khan/RecordRTC
 * 
 * 功能: 安全地刪除伺服器上的音頻檔案
 *================================================================*/

// 允許跨域請求（CORS）
header("Access-Control-Allow-Origin: *");

/**
 * 主要的檔案刪除處理函數
 * 驗證權限並安全地刪除指定檔案
 */
function selfInvoker()
{
    /*---------------------------------------------------------------
     * 權限檢查
     * 確保請求包含了要刪除的檔案名稱
     *--------------------------------------------------------------*/
    
    if (!isset($_POST['delete-file'])) {
        echo 'PermissionDeniedError'; // 權限被拒絕
        return;
    }
    
    /*---------------------------------------------------------------
     * 檔案路徑設定
     * 構建要刪除的檔案完整路徑
     *--------------------------------------------------------------*/
    
    $fileName = $_POST['delete-file'];              // 檔案名稱
    $filePath = '../public/uploads/' . $fileName;  // 完整檔案路徑
    
    /*---------------------------------------------------------------
     * 檔案類型安全檢查
     * 只允許刪除指定類型的音頻/視頻檔案
     *--------------------------------------------------------------*/
    
    // 允許刪除的檔案副檔名清單
    $allowed = array(
        'webm',  // WebM 視頻格式
        'wav',   // WAV 音頻格式
        'mp4',   // MP4 視頻格式
        "mkv",   // MKV 視頻格式
        'mp3',   // MP3 音頻格式
        'ogg'    // OGG 音頻格式
    );
    
    $extension = pathinfo($filePath, PATHINFO_EXTENSION); // 提取副檔名
    
    // 檢查副檔名是否在允許清單中
    if (!$extension || empty($extension) || !in_array($extension, $allowed)) {
        echo 'PermissionDeniedError'; // 不允許的檔案類型
        return;
    }
    
    /*---------------------------------------------------------------
     * 執行檔案刪除
     * 嘗試刪除檔案並回報結果
     *--------------------------------------------------------------*/
    
    if (!unlink($filePath)) {
        echo ('Problem deleting file.'); // 刪除失敗
    } else {
        echo ($fileName . ' deleted successfully.'); // 刪除成功
    }
}

/*=================================================================
 * 執行主要處理函數
 * 啟動檔案刪除處理流程
 *================================================================*/

selfInvoker(); // 調用主要處理函數
?>
